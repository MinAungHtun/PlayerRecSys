<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Player Recommender</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background inspired by sports/tech themes */
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.6);
        }
        .primary-btn {
            background-color: #238636;
            transition: background-color 0.2s;
        }
        .primary-btn:hover {
            background-color: #2ea043;
        }
        .dropdown-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7rem top 50%;
            background-size: 1.5rem auto;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">NBA Player Recommender</h1>
            <p class="text-xl text-gray-400">Find players with similar performance profiles using your 2024-2025 game data.</p>
        </header>

        <!-- Main Recommender Panel -->
        <div class="card p-6 md:p-10 rounded-2xl">
            <h2 class="text-2xl font-bold text-white mb-6">1. Select a Player & Metric</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Player Selection -->
                <div>
                    <label for="player-select" class="block text-sm font-medium text-gray-300 mb-2">Target Player</label>
                    <div class="relative">
                        <select id="player-select" class="dropdown-select w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-green-500 focus:border-green-500 text-base" disabled>
                            <option value="">Loading Players...</option>
                        </select>
                    </div>
                </div>

                <!-- Metric Selection -->
                <div>
                    <label for="metric-select" class="block text-sm font-medium text-gray-300 mb-2">Similarity Metric</label>
                    <select id="metric-select" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-green-500 focus:border-green-500 text-base">
                        <option value="GmSc">Game Score (Overall Performance)</option>
                        <option value="PTS">Points (Scoring Focus)</option>
                        <option value="AST">Assists (Playmaking Focus)</option>
                        <option value="TRB">Total Rebounds (Rebounding Focus)</option>
                        <option value="BLK">Blocks (Defensive Focus)</option>
                        <option value="3P%">3P% (Three-Point Shooting Efficiency)</option>
                    </select>
                </div>

                <!-- Action Button -->
                <div class="flex items-end pt-2 md:pt-0">
                    <button id="recommend-btn" class="primary-btn w-full p-3 rounded-lg font-semibold text-lg text-white disabled:opacity-50" disabled>
                        Get Recommendations
                    </button>
                </div>
            </div>

            <!-- Loading Indicator & Status Message -->
            <div id="status-message" class="text-center text-sm text-yellow-400 my-4 hidden">
                Loading and processing data...
            </div>
            <div id="error-message" class="text-center text-sm text-red-400 my-4 hidden">
                Error loading data. Check the console for details.
            </div>

            <hr class="border-gray-700 my-8">

            <h2 class="text-2xl font-bold text-white mb-6">2. Top 5 Similar Players</h2>

            <!-- Recommendations Output -->
            <div id="recommendation-list" class="space-y-4">
                <p class="text-gray-500 text-center p-4 rounded-lg bg-gray-800">Select a player and click "Get Recommendations" to see results.</p>
            </div>
        </div>

        <footer class="mt-8 text-center text-gray-500 text-sm">
            Data Source: database_24_25.csv | Built with Gemini & Tailwind CSS
        </footer>

    </div>

    <script>
        // Global variables for data and Firebase config
        let playerData = [];
        const PLAYER_SELECT = document.getElementById('player-select');
        const METRIC_SELECT = document.getElementById('metric-select');
        const RECOMMEND_BTN = document.getElementById('recommend-btn');
        const RECOMMENDATION_LIST = document.getElementById('recommendation-list');
        const STATUS_MESSAGE = document.getElementById('status-message');
        const ERROR_MESSAGE = document.getElementById('error-message');

        // Helper function to format metric values
        function formatMetric(key, value) {
            if (key.includes('%')) {
                return (value * 100).toFixed(1) + '%';
            }
            return parseFloat(value).toFixed(1);
        }

        // --- Data Loading and Parsing ---

        async function loadAndParseCSV() {
            STATUS_MESSAGE.textContent = "Loading and processing data...";
            STATUS_MESSAGE.classList.remove('hidden');
            RECOMMEND_BTN.disabled = true;

            try {
                // Fetch the uploaded CSV file (Note: contentFetchId is provided by the environment)
                const fetchId = "uploaded:database_24_25.csv";
                const response = await fetch(`fetch-file/${fetchId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                playerData = parseCSV(csvText);

                // Populate the dropdown with unique player names
                populatePlayerDropdown(playerData);

                STATUS_MESSAGE.classList.add('hidden');
                RECOMMEND_BTN.disabled = false;
                PLAYER_SELECT.disabled = false;

            } catch (error) {
                console.error("Failed to load or parse CSV:", error);
                STATUS_MESSAGE.classList.add('hidden');
                ERROR_MESSAGE.textContent = `Error loading data: ${error.message}`;
                ERROR_MESSAGE.classList.remove('hidden');
            }
        }

        function parseCSV(csvText) {
            // Split by newline, handle various newline formats
            const lines = csvText.trim().split(/\r\n|\n/);
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            // Skip header line (lines[0])
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        // Convert numeric stats to floating point numbers
                        const numericHeaders = ['MP', 'FG', 'FGA', 'FG%', '3P', '3PA', '3P%', 'FT', 'FTA', 'FT%', 'ORB', 'DRB', 'TRB', 'AST', 'STL', 'BLK', 'TOV', 'PF', 'PTS', 'GmSc'];
                        if (numericHeaders.includes(header)) {
                            row[header] = parseFloat(values[index]) || 0; // Use 0 if parsing fails
                        } else {
                            row[header] = values[index];
                        }
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function populatePlayerDropdown(data) {
            // Get unique player names
            const playerNames = [...new Set(data.map(p => p.Player))].sort();

            // Clear loading option and add default
            PLAYER_SELECT.innerHTML = '<option value="" disabled selected>Select a Player...</option>';

            // Add new options
            playerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                PLAYER_SELECT.appendChild(option);
            });
        }

        // --- Recommender System Logic ---

        function calculateSimilarity(targetPlayerName, metric) {
            const targetPlayer = playerData.find(p => p.Player === targetPlayerName);

            if (!targetPlayer) return [];

            const recommendations = playerData
                .filter(p => p.Player !== targetPlayerName) // Don't recommend the player to themselves
                .map(player => {
                    // Calculate the absolute difference (distance) for the selected metric
                    const targetValue = targetPlayer[metric];
                    const currentPlayerValue = player[metric];

                    // Use Math.abs for positive distance
                    const distance = Math.abs(targetValue - currentPlayerValue);

                    // Combine game score difference with player info
                    return {
                        ...player,
                        distance: distance,
                        targetMetric: metric,
                        targetPlayerValue: targetValue,
                        similarPlayerValue: currentPlayerValue
                    };
                })
                // Sort by the lowest distance (most similar)
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5); // Get top 5

            return recommendations;
        }

        // --- UI Rendering ---

        function renderRecommendations(recommendations, targetPlayerName, metric) {
            RECOMMENDATION_LIST.innerHTML = ''; // Clear previous results

            if (recommendations.length === 0) {
                RECOMMENDATION_LIST.innerHTML = `<p class="text-gray-500 text-center p-4 rounded-lg bg-gray-800">No similar players found for ${targetPlayerName} based on ${metric}.</p>`;
                return;
            }

            const targetPlayer = playerData.find(p => p.Player === targetPlayerName);
            const targetValue = formatMetric(metric, targetPlayer[metric]);

            // Add a header for context
            const headerHtml = `
                <div class="bg-gray-800 p-4 rounded-xl mb-4">
                    <p class="text-xl font-semibold text-white">Target Player: <span class="text-green-400">${targetPlayerName}</span></p>
                    <p class="text-md text-gray-400">Target ${metric}: <span class="font-mono">${targetValue}</span></p>
                </div>
            `;
            RECOMMENDATION_LIST.innerHTML += headerHtml;


            recommendations.forEach((rec, index) => {
                const recValue = formatMetric(metric, rec.similarPlayerValue);
                const distance = formatMetric(metric, rec.distance);

                const itemHtml = `
                    <div class="card p-4 rounded-xl flex items-center justify-between border-l-4 border-green-500">
                        <div class="flex-1">
                            <p class="text-lg font-bold text-white">${index + 1}. ${rec.Player} (${rec.Tm})</p>
                            <p class="text-sm text-gray-400">Game Date: ${rec.Data}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-semibold text-green-400">${metric}: ${recValue}</p>
                            <p class="text-sm text-gray-500">Difference: ${distance}</p>
                        </div>
                    </div>
                `;
                RECOMMENDATION_LIST.innerHTML += itemHtml;
            });
        }

        // --- Event Handlers ---

        RECOMMEND_BTN.addEventListener('click', () => {
            const selectedPlayer = PLAYER_SELECT.value;
            const selectedMetric = METRIC_SELECT.value;

            if (selectedPlayer) {
                const recommendations = calculateSimilarity(selectedPlayer, selectedMetric);
                renderRecommendations(recommendations, selectedPlayer, selectedMetric);
            } else {
                RECOMMENDATION_LIST.innerHTML = `<p class="text-red-400 text-center p-4 rounded-lg bg-gray-800">Please select a player first.</p>`;
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', loadAndParseCSV);
    </script>

</body>
</html>
